# Enable C++ support
language: cpp

# Compiler selection
matrix:
  include:  
    - compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-4.9
            - gdb
            - apport
        
before_install:
  - |
    if [[ "linux" == "linux" ]]; then    
      mkdir -p ${OPENCL_ROOT}
      bash .travis/amd_sdk.sh ${AMDAPPSDK_VERSION}
      tar -xjf AMD-SDK.tar.bz2
      export OPENCL_VENDOR_PATH=${AMDAPPSDKROOT}/etc/OpenCL/vendors
      mkdir -p ${OPENCL_VENDOR_PATH}
      sh AMD-APP-SDK*.sh --tar -xf -C ${AMDAPPSDKROOT}
      echo libamdocl64.so > ${OPENCL_VENDOR_PATH}/amdocl64.icd
      export LD_LIBRARY_PATH=${AMDAPPSDKROOT}/lib/x86_64:${LD_LIBRARY_PATH}
      export CMAKE_LIBRARY_PATH=${AMDAPPSDKROOT}/lib/x86_64;      
      chmod +x ${AMDAPPSDKROOT}/bin/x86_64/clinfo
      ${AMDAPPSDKROOT}/bin/x86_64/clinfo
      rm AMD-APP-SDK*.sh
      rm AMD-SDK.tar.bz2
    fi    
    
install:
  - export CPLUS_INCLUDE_PATH=${AMDAPPSDKROOT}/include
  - export LD_LIBRARY_PATH=${AMDAPPSDKROOT}/lib/x86_64:${LD_LIBRARY_PATH}
  - export LIBRARY_PATH=${AMDAPPSDKROOT}/lib/x86_64:${LIBRARY_PATH}
  - export CXX="g++-4.9"
  - ulimit -c
  - ulimit -a -S
  - ulimit -a -H
  - cat /proc/sys/kernel/core_pattern  
  - cd build
  - cmake -DUSE_SYSTEM_TBB=OFF -DNO_RTM=TRUE ..  
  
before_script:
 - ulimit -c unlimited -S # Enable core dumps
  
# Build steps
script:
  - make
  - ./benchmark --iterations 10
  - ./benchmark --iterations 10 --gpu
  - ./benchmark --iterations 10 --float
  - ./benchmark --iterations 10 --float --gpu
  - ./benchmark --iterations 10 --truncation
  - ./benchmark --iterations 10 --truncation --gpu
  - ./benchmark --iterations 10 --truncation --float
  - ./benchmark --iterations 10 --truncation --float --gpu  
    
after_failure:
  - ls
  - COREFILE=$(find . -maxdepth 1 -name "core*" | head -n 1) # find core file
  - if [[ -f "$COREFILE" ]]; then gdb -c "$COREFILE" ./benchmark -ex "thread apply all bt" -ex "set pagination 0" -batch; fi
  
env:
  global:
  - OPENCL_ROOT=$HOME/opencl
  - OPENCL_LIB=amdappsdk
  - OPENCL_VERSION="12"
  - AMDAPPSDK_VERSION=291 # OpenCL 1.2   
  - AMDAPPSDKROOT=${OPENCL_ROOT}/AMDAPPSDK    
